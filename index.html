<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒªãƒ³ã‚¯æ©Ÿæ§‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ï¼ˆ8ãƒãƒ¼ãƒªãƒ³ã‚¯ï¼‰</title>
  <style>
    :root { --bg:#ffffff; --panel:#f4f4f4; --ink:#000000; --muted:#555555; --grid:#cccccc; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; background:var(--bg); color:var(--ink); }
    .wrap { display:grid; grid-template-columns: 360px 1fr; gap:12px; padding:12px; }
    .panel { background:var(--panel); border:1px solid #1f2840; border-radius:12px; padding:12px; }
    h1 { font-size:16px; margin:0 0 8px 0; }
    .hint { color:var(--muted); font-size:12px; line-height:1.5; margin:6px 0 10px; }
    .row { display:grid; grid-template-columns: 1fr 110px; gap:8px; align-items:center; margin:8px 0; }
    .row label { font-size:13px; }
    input[type="number"] { width:100%; padding:6px 8px; border-radius:8px; border:1px solid #2a3653; background:#ffffff; color:var(--ink); }
    input[type="range"] { width:100%; }
    .slider { display:grid; grid-template-columns: 1fr 60px; gap:8px; align-items:center; margin-top:4px; }
    .small { font-size:12px; color:var(--muted); }
    canvas { width:100%; height:calc(100vh - 24px); background:#ffffff; border:1px solid #1f2840; border-radius:12px; }
    .stat { font-size:12px; color:var(--muted); line-height:1.6; margin-top:10px; white-space:pre-wrap; }
    button { cursor:pointer; border:1px solid #2a3653; background:#ffffff; color:var(--ink); padding:8px 10px; border-radius:10px; font-size:13px; }
    .btnrow { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    @media (max-width: 980px) {
      .wrap { grid-template-columns: 1fr; }
      canvas { height: 58vh; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>ãƒªãƒ³ã‚¯æ©Ÿæ§‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ï¼ˆ8ãƒãƒ¼ãƒªãƒ³ã‚¯ï¼‰</h1>
      <div class="hint">
        å›ºå®šï¼šA=(0,a), D=(d,0)ã€‚B=A+AB[cosÎ¸,sinÎ¸]ã€‚<br>
        æ¥”ï¼šBâ†’Câ†’Dâ†’Hâ†’B ã‚’ã€ŒBãŒåå°„è§’ï¼ˆ>180Â°ï¼‰ã€ã«ãªã‚‹æã§è‡ªå‹•é¸æŠã€‚<br>
        è»Œè·¡ï¼ˆFï¼‰ã‚’ãƒªãƒ³ã‚¯æ©Ÿæ§‹ã«é‡ã­æãã—ã¾ã™ã€‚èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ã¯å›ºå®šã§ã™ğŸ˜Š
      </div>

      <div class="row"><label>a</label><input id="a_num" type="number" value="0"></div>
      <div class="slider"><input id="a_rng" type="range"><span id="a_show" class="small"></span></div>

      <div class="row"><label>d</label><input id="d_num" type="number" value="40"></div>
      <div class="slider"><input id="d_rng" type="range"><span id="d_show" class="small"></span></div>

      <hr style="border:0;border-top:1px solid #1f2840;margin:12px 0;" />

      <div class="row"><label>AB</label><input id="AB_num" type="number" value="20"></div>
      <div class="slider"><input id="AB_rng" type="range"><span id="AB_show" class="small"></span></div>

      <div class="row"><label>BC</label><input id="BC_num" type="number" value="57"></div>
      <div class="slider"><input id="BC_rng" type="range"><span id="BC_show" class="small"></span></div>

      <div class="row"><label>CD</label><input id="CD_num" type="number" value="72"></div>
      <div class="slider"><input id="CD_rng" type="range"><span id="CD_show" class="small"></span></div>

      <div class="row"><label>BH</label><input id="BH_num" type="number" value="36"></div>
      <div class="slider"><input id="BH_rng" type="range"><span id="BH_show" class="small"></span></div>

      <div class="row"><label>DH</label><input id="DH_num" type="number" value="54"></div>
      <div class="slider"><input id="DH_rng" type="range"><span id="DH_show" class="small"></span></div>

      <div class="row"><label>CEï¼ˆåˆæœŸ103ï¼‰</label><input id="CE_num" type="number" value="103"></div>
      <div class="slider"><input id="CE_rng" type="range"><span id="CE_show" class="small"></span></div>

      <div class="row"><label>EG</label><input id="EG_num" type="number" value="61"></div>
      <div class="slider"><input id="EG_rng" type="range"><span id="EG_show" class="small"></span></div>

      <div class="row"><label>GH</label><input id="GH_num" type="number" value="22"></div>
      <div class="slider"><input id="GH_rng" type="range"><span id="GH_show" class="small"></span></div>

      <div class="row"><label>FH</label><input id="FH_num" type="number" value="67"></div>
      <div class="slider"><input id="FH_rng" type="range"><span id="FH_show" class="small"></span></div>

      <hr style="border:0;border-top:1px solid #1f2840;margin:12px 0;" />

      <div class="row"><label>Î¸ï¼ˆè¡¨ç¤ºï¼‰</label><input id="theta_num" type="number" value="0"></div>
      <div class="slider"><input id="theta_rng" type="range"><span id="theta_show" class="small"></span></div>

      <div class="btnrow">
        <button id="btn_play">â–¶ å†ç”Ÿ</button>
        <button id="btn_reset">âŸ² ãƒªã‚»ãƒƒãƒˆå†è¨ˆç®—</button>
        <button id="btn_recalc">è»Œè·¡ã‚’å†è¨ˆç®—</button>
        <button id="btn_preset">åˆæœŸå€¤ã«æˆ»ã™</button>
      </div>

      <div class="stat" id="stat">ãƒ­ã‚°:</div>
    </div>

    <canvas id="canvas_main"></canvas>
  </div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  const stat = document.getElementById("stat");
  const log = (s) => { stat.textContent = "ãƒ­ã‚°:\n" + s; };

  try {
    // ---------- helpers ----------
    const TAU = Math.PI * 2;
    const deg2rad = d => d * Math.PI / 180;
    const clampInt = (v, lo, hi) => {
      const n = Number(v);
      const x = Number.isFinite(n) ? Math.round(n) : lo;
      return Math.max(lo, Math.min(hi, x));
    };
    const dist = (p,q) => Math.hypot(p.x-q.x, p.y-q.y);
    const add  = (p,q) => ({x:p.x+q.x, y:p.y+q.y});
    const sub  = (p,q) => ({x:p.x-q.x, y:p.y-q.y});
    const mul  = (p,s) => ({x:p.x*s, y:p.y*s});
    const norm = v => {
      const L = Math.hypot(v.x, v.y);
      return L > 1e-9 ? {x:v.x/L, y:v.y/L} : {x:0,y:0};
    };

    function circleCircle(c0, r0, c1, r1) {
      const dx = c1.x - c0.x, dy = c1.y - c0.y;
      const d = Math.hypot(dx, dy);
      if (d < 1e-9) return [];
      if (d > r0 + r1 + 1e-9) return [];
      if (d < Math.abs(r0 - r1) - 1e-9) return [];
      const a = (r0*r0 - r1*r1 + d*d) / (2*d);
      const h2 = r0*r0 - a*a;
      const h = h2 <= 1e-9 ? 0 : Math.sqrt(h2);
      const xm = c0.x + a * (dx/d);
      const ym = c0.y + a * (dy/d);
      const rx = -(dy/d) * h;
      const ry =  (dx/d) * h;
      const p1 = {x: xm + rx, y: ym + ry};
      const p2 = {x: xm - rx, y: ym - ry};
      return (h === 0) ? [p1] : [p1, p2];
    }

    // ---------- concavity-at-B selection ----------
    function cross(a,b,c){
      return (b.x-a.x)*(c.y-a.y) - (b.y-a.y)*(c.x-a.x);
    }
    function polygonArea2(B,C,D,H){
      return B.x*C.y - B.y*C.x
           + C.x*D.y - C.y*D.x
           + D.x*H.y - D.y*H.x
           + H.x*B.y - H.y*B.x;
    }
    function isReflexAtB(B,C,D,H){
      const orient = Math.sign(polygonArea2(B,C,D,H)) || 1; // +1 CCW, -1 CW
      const local = cross(B, C, H); // cross((C-B),(H-B))
      return Math.sign(local) !== orient;
    }
    function segIntersect(p1,p2,q1,q2){
      const o = (a,b,c)=>Math.sign(cross(a,b,c));
      const onSeg=(a,b,c)=>Math.min(a.x,b.x)-1e-9<=c.x&&c.x<=Math.max(a.x,b.x)+1e-9
                   &&Math.min(a.y,b.y)-1e-9<=c.y&&c.y<=Math.max(a.y,b.y)+1e-9;
      const o1=o(p1,p2,q1), o2=o(p1,p2,q2), o3=o(q1,q2,p1), o4=o(q1,q2,p2);
      if (o1===0 && onSeg(p1,p2,q1)) return true;
      if (o2===0 && onSeg(p1,p2,q2)) return true;
      if (o3===0 && onSeg(q1,q2,p1)) return true;
      if (o4===0 && onSeg(q1,q2,p2)) return true;
      return (o1!==o2 && o3!==o4);
    }
    function chooseCH(B, D, Ccands, Hcands, prevCH){
      if (!Ccands?.length || !Hcands?.length) return null;

      let best = null;
      let bestScore = Infinity;
      let fallback = null;
      let fallbackScore = Infinity;

      for (const C of Ccands){
        for (const H of Hcands){
          // è‡ªå·±äº¤å·®å›é¿ï¼ˆBCã¨DHã€CDã¨HBï¼‰
          if (segIntersect(B,C, D,H)) continue;
          if (segIntersect(C,D, H,B)) continue;

          const reflexB = isReflexAtB(B,C,D,H);

          // ã‚¹ã‚³ã‚¢ï¼šå‰ãƒ•ãƒ¬ãƒ¼ãƒ ã«è¿‘ã„ã»ã©å„ªå…ˆï¼ˆãªã‘ã‚Œã°ä¸Šå´ã‚’å°‘ã—å„ªå…ˆï¼‰
          let score = 0;
          if (prevCH){
            score += dist(C, prevCH.C) + dist(H, prevCH.H);
          } else {
            score += -0.01*(C.y + H.y);
          }

          if (reflexB) {
            if (score < bestScore) { bestScore = score; best = {C,H}; }
          } else {
            if (score < fallbackScore) { fallbackScore = score; fallback = {C,H}; }
          }
        }
      }
      return best || fallback;
    }

    // ---------- UI map ----------
    const cfg = [
      ["a",0,200],["d",1,300],
      ["AB",1,300],["BC",1,500],["CD",1,500],["BH",1,500],["DH",1,500],
      ["CE",1,600],["EG",1,800],["GH",1,800],["FH",1,900],
      ["theta",0,360],
    ];

    // ---------- default preset ----------
    function applyDefaultPreset(){
      const v = {
        a:5, d:40,
        AB:20, BC:57, CD:72,
        BH:36, DH:54,
        CE:103, EG:55, GH:22, FH:85,
        theta:0
      };
      for (const k in v) {
        document.getElementById(k+"_num").value = v[k];
      }
      for (const [k, lo, hi] of cfg) setRangeAndSync(k, lo, hi);
    }

    const el = {};
    for (const [k] of cfg) {
      el[k+"_num"] = document.getElementById(k+"_num");
      el[k+"_rng"] = document.getElementById(k+"_rng");
      el[k+"_show"] = document.getElementById(k+"_show");
      if (!el[k+"_num"] || !el[k+"_rng"] || !el[k+"_show"]) {
        throw new Error("è¦ç´ IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + k);
      }
    }

    function setRangeAndSync(k, lo, hi) {
      el[k+"_rng"].min = lo; el[k+"_rng"].max = hi; el[k+"_rng"].step = 1;
      el[k+"_num"].min = lo; el[k+"_num"].max = hi; el[k+"_num"].step = 1;
      const v = clampInt(el[k+"_num"].value, lo, hi);
      el[k+"_num"].value = v;
      el[k+"_rng"].value = v;
      el[k+"_show"].textContent = String(v);
      el[k+"_num"].setAttribute("value", String(v));
    }

    function getInt(k) {
      const v = parseInt(el[k+"_num"].value, 10);
      return Number.isFinite(v) ? v : 0;
    }

    for (const [k, lo, hi] of cfg) setRangeAndSync(k, lo, hi);

    function setTheta(v){
      const x = ((Math.round(v) % 361) + 361) % 361; // 0..360
      el["theta_num"].value = x;
      el["theta_rng"].value = x;
      el["theta_show"].textContent = String(x);
      el["theta_num"].setAttribute("value", String(x));
    }

    function syncPair(k, lo, hi) {
      const num = el[k+"_num"], rng = el[k+"_rng"], show = el[k+"_show"];
      const apply = (v) => {
        const x = clampInt(v, lo, hi);
        num.value = x;
        rng.value = x;
        show.textContent = String(x);
        num.setAttribute("value", String(x));
      };
      apply(num.value);

      rng.addEventListener("input", () => {
        apply(rng.value);
        if (k==="theta") drawAll();
      });
      num.addEventListener("input", () => {
        apply(num.value);
        if (k==="theta") drawAll();
      });
    }
    for (const [k, lo, hi] of cfg) syncPair(k, lo, hi);

    // ---------- canvas ----------
    const canvas = document.getElementById("canvas_main");
    const ctx = canvas.getContext("2d");

    function fitCanvas() {
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width  = Math.max(1, Math.round(rect.width  * dpr));
      canvas.height = Math.max(1, Math.round(rect.height * dpr));
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {W:rect.width, H:rect.height};
    }

    // èƒŒæ™¯å›ºå®šã‚°ãƒªãƒƒãƒ‰ï¼ˆoriginç„¡è¦–ï¼‰
    function grid(ctx,W,H){
      ctx.clearRect(0,0,W,H);
      ctx.save();
      ctx.lineWidth=1;
      ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid').trim();
      const step=20;
      for (let x=0; x<=W; x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
      for (let y=0; y<=H; y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
      ctx.restore();
    }

    function w2s(p, origin, s){return {x: origin.x + (-p.x)*s, y: origin.y - p.y*s};}
    function seg(ctx, p,q, origin, s){
      const a = w2s(p,origin,s), b = w2s(q,origin,s);
      ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
    }
    function pt(ctx, p, origin, s, name, r=4){
      const q = w2s(p,origin,s);
      ctx.beginPath(); ctx.arc(q.x,q.y,r,0,TAU); ctx.fill();
      if (name) ctx.fillText(name, q.x+6, q.y-6);
    }

    // ---------- solve ----------
    function solveFrame(thetaDeg, prev) {
      const a = getInt("a"), d = getInt("d");
      const AB = getInt("AB"), BC = getInt("BC"), CD = getInt("CD"), BH = getInt("BH"), DH = getInt("DH");
      const CE = getInt("CE"), EG = getInt("EG"), GH = getInt("GH"), FH = getInt("FH");

      const DE = CE - CD;
      if (DE <= 0) return { ok:false, reason:"CE <= CDï¼ˆDãŒCEä¸Šã«ç½®ã‘ãªã„ï¼‰" };
      if (FH <= GH) return { ok:false, reason:"FH <= GHï¼ˆGãŒFHä¸Šã«ç½®ã‘ãªã„ï¼‰" };

      const A = {x:0, y:a};
      const D = {x:d, y:0};

      const th = deg2rad(-thetaDeg);
      const B = { x: A.x + AB*Math.cos(th), y: A.y + AB*Math.sin(th) };

      // C/Hã‚’ã€ŒBãŒåå°„è§’ã€ã«ãªã‚‹æã§æ±ºã‚ã‚‹
      const Ccands = circleCircle(B,BC, D,CD);
      const Hcands = circleCircle(B,BH, D,DH);
      const chosen = chooseCH(B, D, Ccands, Hcands, prev ? {C:prev.C, H:prev.H} : null);
      if (!chosen) return { ok:false, reason:"C/HãŒè§£ã‘ãªã„ï¼ˆæ¥”ã®æãŒä½œã‚Œãªã„ï¼‰", A,D,B };

      const C = chosen.C;
      const H = chosen.H;

      // Eï¼šC-Dæ–¹å‘ã«Dã‹ã‚‰DEã ã‘å»¶é•·ï¼ˆDã¯CEä¸Šï¼‰
      const u = norm(sub(D,C));
      const E = add(D, mul(u, DE));

      // Gï¼šå††(E,EG) ã¨ å††(H,GH) ã®äº¤ç‚¹
      const Gcands = circleCircle(E,EG, H,GH);
      let G = null;
      if (Gcands.length === 1) G = Gcands[0];
      else if (Gcands.length === 2) {
        if (prev?.G) G = (dist(Gcands[0], prev.G) <= dist(Gcands[1], prev.G)) ? Gcands[0] : Gcands[1];
        else G = (Gcands[0].y < Gcands[1].y) ? Gcands[0] : Gcands[1];
      }
      if (!G) return { ok:false, reason:"GãŒè§£ã‘ãªã„ï¼ˆEGã¨GHãŒäº¤ã‚ã‚‰ãªã„ï¼‰", A,D,B,C,H,E };

      // Fï¼šHâ†’Gæ–¹å‘ã¸FHã ã‘ï¼ˆGã¯FHä¸Šã®ç‚¹ï¼‰
      const w = norm(sub(G,H));
      const F = add(H, mul(w, FH));

      const reflexB = isReflexAtB(B,C,D,H);
      return { ok:true, A,D,B,C,H,E,G,F, reflexB };
    }

    // ---------- trajectory ----------
    let traj = [];
    let lastGood = null;

    function computeTrajectory() {
      traj = [];
      lastGood = null;
      for (let t=0; t<=360; t++){
        const fr = solveFrame(t, lastGood);
        if (fr.ok) lastGood = fr;
        traj.push({theta:t, ok:fr.ok, frame:fr, F:fr.F, reason:fr.reason});
      }
    }

    // ---------- draw (trajectory over mechanism) ----------
    function drawAll() {
      const {W, H} = fitCanvas();

      const theta = getInt("theta");
      const rec = traj.find(r => r.theta===theta && r.ok);
      const fr = rec ? rec.frame : solveFrame(theta, lastGood);

      // èƒŒæ™¯å›ºå®šã‚°ãƒªãƒƒãƒ‰
      grid(ctx, W, H);

      ctx.save();
      ctx.font="12px system-ui";
      ctx.lineWidth=2;

      // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼šè»Œè·¡F + ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ç‚¹
      const pts = traj.filter(r=>r.ok).map(r=>r.F);
      if (fr.ok){
        for (const k of ["A","D","B","C","H","E","G","F"]) pts.push(fr[k]);
      }

      if (pts.length < 2) {
        ctx.fillStyle="#ffd1d1";
        ctx.fillText("è§£ã‘ãªã„: " + (fr.reason||"ï¼ˆè§£ãŒã»ã¼ç„¡ã„ï¼‰"), 12, 18);
        ctx.restore();

        const invalid = traj.filter(r=>!r.ok).length;
        const firstBad = traj.find(r=>!r.ok);
        log(
          "UIåŒæœŸOK\n" +
          `è§£ã‘ãªã„Î¸: ${invalid}/361\n` +
          `firstBad@Î¸=${firstBad ? firstBad.theta : "none"} reason=${firstBad ? (firstBad.frame?.reason || firstBad.reason) : "none"}`
        );
        return;
      }

      let minX=1e9,maxX=-1e9,minY=1e9,maxY=-1e9;
      for (const p of pts){
        minX=Math.min(minX,p.x); maxX=Math.max(maxX,p.x);
        minY=Math.min(minY,p.y); maxY=Math.max(maxY,p.y);
      }
      const pad=10;
      minX-=pad; maxX+=pad; minY-=pad; maxY+=pad;

      const s = Math.min(W/(maxX-minX), H/(maxY-minY)) * 0.88;
      const VIEW_OFFSET_X = 240;
      const origin = {x: W/2 - ((minX+maxX)/2)*s + VIEW_OFFSET_X, y: H/2 + ((minY+maxY)/2)*s};

      // è»¸ï¼ˆèƒŒæ™¯å›ºå®šã§ã‚‚ã€è»¸ã¯æ©Ÿæ§‹åº§æ¨™ç³»ã«åˆã‚ã›ã¦æãï¼‰
      ctx.strokeStyle="#999";
      seg(ctx,{x:-999,y:0},{x:999,y:0},origin,s);
      seg(ctx,{x:0,y:-999},{x:0,y:999},origin,s);

      // è»Œè·¡ï¼ˆå…ˆã«æã„ã¦ä¸‹æ•·ãã«ï¼‰
      ctx.save();
      ctx.globalAlpha = 0.9;
      ctx.lineWidth = 2;
      let prev=null;
      for (const r of traj){
        if (!r.ok){ prev=null; continue; }
        if (!prev){ prev=r; continue; }
        const dx = r.F.x - prev.F.x;
        ctx.strokeStyle = (dx>=0) ? "#000" : "#666"; // å¾€è·¯/å¾©è·¯
        seg(ctx, prev.F, r.F, origin, s);
        prev=r;
      }
      ctx.restore();

      // ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒªãƒ³ã‚¯
      if (!fr.ok){
        ctx.fillStyle="#ffd1d1";
        ctx.fillText("è§£ã‘ãªã„: " + (fr.reason||""), 12, 18);
      } else {
        const {A,D,B,C,H,E,G,F} = fr;

        // æœ¬ä½“ãƒªãƒ³ã‚¯ï¼ˆæ¥”ï¼‹ã²ã—å½¢ç³»ï¼‰
        ctx.strokeStyle="#000";
        seg(ctx,A,B,origin,s); // AB
        seg(ctx,B,C,origin,s); // BC
        seg(ctx,C,D,origin,s); // CD
        seg(ctx,B,H,origin,s); // BH
        seg(ctx,H,D,origin,s); // DH
        seg(ctx,C,E,origin,s); // CEï¼ˆãƒ©ã‚¤ãƒ³ï¼‰

        seg(ctx,D,E,origin,s);
        seg(ctx,E,G,origin,s);
        seg(ctx,G,H,origin,s);
        seg(ctx,H,D,origin,s);

        // FH
        ctx.strokeStyle="#000";
        seg(ctx,H,F,origin,s);

        // ç‚¹ãƒ©ãƒ™ãƒ«
        ctx.fillStyle="#000";
        pt(ctx,A,origin,s,"A"); pt(ctx,D,origin,s,"D"); pt(ctx,B,origin,s,"B");
        pt(ctx,C,origin,s,"C"); pt(ctx,H,origin,s,"H"); pt(ctx,E,origin,s,"E"); pt(ctx,G,origin,s,"G");
        ctx.fillStyle="#b6ffd6"; pt(ctx,F,origin,s,"F",5);

        // ã„ã¾ã®Fä½ç½®ãƒãƒ¼ã‚«ãƒ¼ï¼ˆè»Œè·¡ã®ä¸Šã«è¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰
        const q = w2s(F, origin, s);
        ctx.fillStyle="#000";
        ctx.beginPath(); ctx.arc(q.x,q.y,6,0,TAU); ctx.fill();

        // è¡¨ç¤ºæƒ…å ±
        ctx.fillStyle = "#000";
        ctx.fillText(`Î¸=${theta}Â°);
      }

      ctx.restore();

      // log
      const invalid = traj.filter(r=>!r.ok).length;
      const firstBad = traj.find(r=>!r.ok);
      log(
        "UIåŒæœŸOK\n" +
        `è§£ã‘ãªã„Î¸: ${invalid}/361\n` +
        `firstBad@Î¸=${firstBad ? firstBad.theta : "none"} reason=${firstBad ? (firstBad.frame?.reason || firstBad.reason) : "none"}\n` +
        `DE=CE-CD=${getInt("CE")-getInt("CD")}, FH-GH=${getInt("FH")-getInt("GH")}`
      );
    }

    // ---------- buttons / animation ----------
    document.getElementById("btn_recalc").addEventListener("click", () => {
      computeTrajectory();
      drawAll();
    });

    document.getElementById("btn_preset").addEventListener("click", () => {
      applyDefaultPreset();
      computeTrajectory();
      drawAll();
    });

    let playing = false;
    let rafId = null;
    const btnPlay = document.getElementById("btn_play");
    const btnReset = document.getElementById("btn_reset");

    function tick(){
      if (!playing) return;
      const th = (getInt("theta") + 1) % 361;
      setTheta(th);
      drawAll();
      rafId = requestAnimationFrame(tick);
    }

    btnPlay.addEventListener("click", () => {
      playing = !playing;
      btnPlay.textContent = playing ? "â¸ åœæ­¢" : "â–¶ å†ç”Ÿ";
      if (playing) tick();
      else if (rafId) cancelAnimationFrame(rafId);
    });

    btnReset.addEventListener("click", () => {
      playing = false;
      btnPlay.textContent = "â–¶ å†ç”Ÿ";
      if (rafId) cancelAnimationFrame(rafId);

      setTheta(0);
      computeTrajectory();
      drawAll();
    });

    // init
    applyDefaultPreset();
    computeTrajectory();
    drawAll();
    window.addEventListener("resize", () => drawAll());

  } catch (e) {
    log("JavaScriptã‚¨ãƒ©ãƒ¼:\n" + (e && e.stack ? e.stack : String(e)));
  }
});
</script>
</body>
</html>

